name: Sync Main to EdgeOne-Pages

on:
  push:
    branches: [main]

jobs:
  sync-to-edgeone:
    runs-on: ubuntu-latest
    
    steps:
      # 1ï¸âƒ£ æ£€å‡º main åˆ†æ”¯
      - name: Checkout main branch
        uses: actions/checkout@v3
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.PERSONAL_TOKEN }}

      # 2ï¸âƒ£ è·å–æœ€æ–°æäº¤ä¿¡æ¯
      - name: Get latest commit info
        id: commit_info
        run: |
          COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s")
          COMMIT_ID=$(git log -1 --pretty=format:"%h")
          echo "commit_message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
          echo "commit_id=$COMMIT_ID" >> $GITHUB_OUTPUT
          echo "Latest commit: $COMMIT_MESSAGE ($COMMIT_ID)"

      # 3ï¸âƒ£ è®¾ç½® Git ç”¨æˆ·
      - name: Set up Git
        run: |
          git config user.name "shimoxijimu-actions"
          git config user.email "shimoxijimu@users.noreply.github.com"

      # 4ï¸âƒ£ å¼ºåˆ¶åŒæ­¥åˆ° EdgeOne-Pages åˆ†æ”¯
      - name: Force sync to EdgeOne-Pages branch
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰ PERSONAL_TOKEN
          if [[ -z "${{ secrets.PERSONAL_TOKEN }}" ]]; then
            echo "Warning: PERSONAL_TOKEN not found. Please set PERSONAL_TOKEN in repository secrets to enable deployment."
            echo "Skipping deployment..."
            exit 0
          fi
          
          echo "ğŸ”„ å¼ºåˆ¶åŒæ­¥ â†’ ç›´æ¥å°† EdgeOne-Pages åˆ†æ”¯é‡ç½®ä¸º main åˆ†æ”¯çš„å®Œå…¨å‰¯æœ¬"
          
          # ç›´æ¥é‡ç½® EdgeOne-Pages åˆ†æ”¯ä¸º main åˆ†æ”¯çš„å®Œå…¨å‰¯æœ¬
          git checkout -B EdgeOne-Pages origin/main
          echo "âœ… EdgeOne-Pages åˆ†æ”¯å·²é‡ç½®ä¸º main åˆ†æ”¯çš„å®Œå…¨å‰¯æœ¬"
          
          # 5ï¸âƒ£ å¤åˆ¶éƒ¨ç½²æ–‡ä»¶ â†’ å°† deploy/ ç›®å½•çš„æ–‡ä»¶å¤åˆ¶åˆ°æ ¹ç›®å½•
          echo "ğŸ“ å¤åˆ¶éƒ¨ç½²æ–‡ä»¶ â†’ å°† deploy/ ç›®å½•çš„æ–‡ä»¶å¤åˆ¶åˆ°æ ¹ç›®å½•"
          if [[ -d "deploy" ]]; then
            echo "Deploy æ–‡ä»¶å¤¹æ‰¾åˆ°ï¼Œå¼€å§‹å¤åˆ¶å†…å®¹..."
            
            # æ˜¾ç¤º deploy æ–‡ä»¶å¤¹å†…å®¹
            echo "Deploy æ–‡ä»¶å¤¹å†…å®¹:"
            ls -la deploy/
            
            # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ï¼Œè¦†ç›–ç°æœ‰æ–‡ä»¶
            cp -rf deploy/* ./
            cp -rf deploy/.* ./ 2>/dev/null || true  # å¤åˆ¶éšè—æ–‡ä»¶ï¼Œå¿½ç•¥é”™è¯¯
            
            echo "âœ… æ–‡ä»¶å¤åˆ¶æˆåŠŸ"
            echo "æ ¹ç›®å½•å†…å®¹ (å¤åˆ¶å):"
            ls -la
            
            # 6ï¸âƒ£ æ›´æ–°å­æ¨¡å—é…ç½® â†’ ç¡®ä¿å­æ¨¡å—æŒ‡å‘æ­£ç¡®çš„åˆ†æ”¯
            echo "ğŸ”§ æ›´æ–°å­æ¨¡å—é…ç½® â†’ ç¡®ä¿å­æ¨¡å—æŒ‡å‘æ­£ç¡®çš„åˆ†æ”¯"
            if [[ -f ".gitmodules" ]]; then
              echo "æ‰¾åˆ° .gitmodules æ–‡ä»¶ï¼Œæ£€æŸ¥å­æ¨¡å—é…ç½®..."
              cat .gitmodules
              
              # åˆå§‹åŒ–å¹¶æ›´æ–°å­æ¨¡å—åˆ°æ­£ç¡®çš„åˆ†æ”¯
              echo "åˆå§‹åŒ–å­æ¨¡å—..."
              git submodule init
              
              echo "åŒæ­¥å­æ¨¡å— URL..."
              git submodule sync
              
              echo "æ›´æ–°å­æ¨¡å—åˆ°æŒ‡å®šåˆ†æ”¯..."
              git submodule update --remote --recursive
              
              echo "âœ… å­æ¨¡å—æ›´æ–°å®Œæˆ"
              echo "å­æ¨¡å—çŠ¶æ€:"
              git submodule status
            else
              echo "âš ï¸ æœªæ‰¾åˆ° .gitmodules æ–‡ä»¶"
            fi
            
            # æ·»åŠ æ‰€æœ‰æ›´æ”¹ï¼ˆåŒ…æ‹¬å­æ¨¡å—æ›´æ”¹ï¼‰
            git add .
            
            # æäº¤æ›´æ”¹
            echo "æäº¤æ›´æ”¹..."
            git commit -m "${{ steps.commit_info.outputs.commit_message }} (${{ steps.commit_info.outputs.commit_id }})" || echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
            
            # 7ï¸âƒ£ å¼ºåˆ¶æ¨é€ â†’ å¼ºåˆ¶æ¨é€æ‰€æœ‰å˜æ›´ï¼Œè¦†ç›–è¿œç¨‹åˆ†æ”¯å†å²
            echo "ğŸš€ å¼ºåˆ¶æ¨é€ â†’ å¼ºåˆ¶æ¨é€æ‰€æœ‰å˜æ›´ï¼Œè¦†ç›–è¿œç¨‹åˆ†æ”¯å†å²"
            git push --force https://x-access-token:${{ secrets.PERSONAL_TOKEN }}@github.com/${{ github.repository }} EdgeOne-Pages
            echo "âœ… æˆåŠŸå¼ºåˆ¶åŒæ­¥ main åˆ° EdgeOne-Pages å¹¶å¤åˆ¶éƒ¨ç½²æ–‡ä»¶"
          else
            echo "âš ï¸ Deploy æ–‡ä»¶å¤¹æœªæ‰¾åˆ°ï¼Œä»…åŒæ­¥ main åˆ†æ”¯å†…å®¹"
            
            # ç›´æ¥å¼ºåˆ¶æ¨é€é‡ç½®åçš„åˆ†æ”¯
            echo "ğŸš€ å¼ºåˆ¶æ¨é€ â†’ æ¨é€é‡ç½®åçš„åˆ†æ”¯"
            git push --force https://x-access-token:${{ secrets.PERSONAL_TOKEN }}@github.com/${{ github.repository }} EdgeOne-Pages
            echo "âœ… æˆåŠŸå¼ºåˆ¶åŒæ­¥ main åˆ° EdgeOne-Pages"
          fi