name: Sync Main Branch Changes to EdgeOne-Pages

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ æ£€å‡ºä»“åº“
      - name: Checkout main branch
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.PERSONAL_TOKEN }}

      # 2ï¸âƒ£ è®¾ç½® Git ç”¨æˆ·
      - name: Set up Git
        run: |
          git config user.name "shimoxijimu-actions"
          git config user.email "shimoxijimu@users.noreply.github.com"

      # 3ï¸âƒ£ åŒæ­¥ main åˆ†æ”¯çš„æ‰€æœ‰å˜åŒ–åˆ° EdgeOne-Pages
      - name: Sync all changes from main to EdgeOne-Pages
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰ PERSONAL_TOKEN
          if [[ -z "${{ secrets.PERSONAL_TOKEN }}" ]]; then
            echo "Warning: PERSONAL_TOKEN not found. Please set PERSONAL_TOKEN in repository secrets to enable deployment."
            echo "Skipping deployment..."
            exit 0
          fi
          
          echo "Starting sync process..."
          BRANCH="EdgeOne-Pages"

          # è·å–å½“å‰æäº¤çš„å˜æ›´æ–‡ä»¶åˆ—è¡¨
          echo "Getting changed files from this push..."
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # æ£€æŸ¥è¿œç¨‹åˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if git ls-remote --exit-code --heads origin $BRANCH >/dev/null 2>&1; then
            echo "Remote branch $BRANCH exists, fetching..."
            git fetch origin $BRANCH
            git checkout -B $BRANCH origin/$BRANCH
          else
            echo "Remote branch $BRANCH does not exist, creating new branch..."
            git checkout -b $BRANCH
          fi

          echo "Current branch: $(git branch --show-current)"

          # åˆ‡æ¢å› main åˆ†æ”¯è·å–æœ€æ–°æ–‡ä»¶
          git checkout main

          # åŒæ­¥å˜æ›´çš„æ–‡ä»¶
          CHANGES_MADE=false
          
          while IFS= read -r file; do
            if [[ -n "$file" && -f "$file" ]]; then
              echo "Processing changed file: $file"
              
              # åˆ‡æ¢åˆ°ç›®æ ‡åˆ†æ”¯
              git checkout $BRANCH
              
              # åˆ›å»ºç›®æ ‡ç›®å½•ï¼ˆå¦‚æœéœ€è¦ï¼‰
              target_dir=$(dirname "$file")
              if [[ "$target_dir" != "." ]]; then
                mkdir -p "$target_dir"
              fi
              
              # ä» main åˆ†æ”¯å¤åˆ¶æ–‡ä»¶
              git checkout main -- "$file"
              
              # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦çœŸçš„æœ‰å˜åŒ–
              if git diff --quiet HEAD "$file" 2>/dev/null; then
                echo "$file unchanged."
              else
                echo "Adding $file to staging..."
                git add "$file"
                CHANGES_MADE=true
              fi
            fi
          done <<< "$CHANGED_FILES"

          # åˆ‡æ¢å›ç›®æ ‡åˆ†æ”¯è¿›è¡Œæäº¤
          git checkout $BRANCH

          # é¢å¤–æ­¥éª¤ï¼šå°† deploy ç›®å½•ä¸‹çš„æ–‡ä»¶å¤åˆ¶åˆ°æ ¹ç›®å½•
          echo "Copying files from deploy/ directory to root..."
          DEPLOY_DIR="deploy"
          
          # å…ˆåˆ‡æ¢åˆ° main åˆ†æ”¯æ£€æŸ¥ deploy ç›®å½•
          git checkout main
          
          if [[ -d "$DEPLOY_DIR" ]]; then
            echo "Deploy directory found, processing files..."
            # è·å– deploy ç›®å½•ä¸­çš„æ–‡ä»¶åˆ—è¡¨
            DEPLOY_FILES=$(find "$DEPLOY_DIR" -maxdepth 1 -type f)
            
            # åˆ‡æ¢åˆ°ç›®æ ‡åˆ†æ”¯è¿›è¡Œæ“ä½œ
            git checkout $BRANCH
            
            for file in $DEPLOY_FILES; do
              filename=$(basename "$file")
              echo "Processing deploy file: $filename"
              
              # ä» main åˆ†æ”¯å¤åˆ¶ deploy æ–‡ä»¶åˆ°æ ¹ç›®å½•
              if git show main:"$file" > "$filename" 2>/dev/null; then
                echo "Successfully copied $filename from main:$file"
              else
                echo "Failed to get $file from main branch using git show, trying alternative method..."
                # ä¸´æ—¶åˆ‡æ¢åˆ° main åˆ†æ”¯å¤åˆ¶æ–‡ä»¶
                git checkout main
                if [[ -f "$file" ]]; then
                  cp "$file" "/tmp/$filename"
                  git checkout $BRANCH
                  mv "/tmp/$filename" "$filename"
                  echo "Successfully copied $filename using alternative method"
                else
                  echo "File $file not found in main branch"
                  git checkout $BRANCH
                  continue
                fi
              fi
              
              # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
              if git diff --quiet HEAD "$filename" 2>/dev/null; then
                echo "Deploy file $filename unchanged."
              else
                echo "Adding deploy file $filename to staging..."
                git add "$filename"
                CHANGES_MADE=true
              fi
            done
          else
            echo "Deploy directory not found, skipping deploy files copy."
            # ç¡®ä¿åˆ‡æ¢å›ç›®æ ‡åˆ†æ”¯
            git checkout $BRANCH
          fi

          # ç¡®ä¿æœ€ååœ¨ç›®æ ‡åˆ†æ”¯ä¸Š
          git checkout $BRANCH

          # æäº¤å¹¶æ¨é€å˜åŒ–
          echo "Final branch check: $(git branch --show-current)"
          echo "Final staging area status:"
          git status --porcelain
          
          if [[ "$CHANGES_MADE" == true ]]; then
            # è·å–åŸå§‹æäº¤ä¿¡æ¯
            ORIGINAL_COMMIT_MSG=$(git log --format=%B -n 1 ${{ github.sha }})
            COMMIT_ID=$(echo ${{ github.sha }} | cut -c1-7)
            
            echo "Committing changes..."
            git commit -m "${ORIGINAL_COMMIT_MSG} (${COMMIT_ID})"
            
            # å°è¯•æ¨é€ï¼Œå¦‚æœå¤±è´¥åˆ™å¼ºåˆ¶æ¨é€
            echo "Pushing to remote..."
            if ! git push https://x-access-token:${{ secrets.PERSONAL_TOKEN }}@github.com/${{ github.repository }} $BRANCH; then
              echo "Normal push failed, trying force push..."
              git push --force https://x-access-token:${{ secrets.PERSONAL_TOKEN }}@github.com/${{ github.repository }} $BRANCH
            fi
            
            echo "âœ… Changes committed and pushed to $BRANCH branch successfully."
          else
            echo "â„¹ï¸ No changes to commit."
          fi
          
          echo "ğŸ‰ Sync process completed!"
